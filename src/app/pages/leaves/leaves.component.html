<div class="card">
  <div class="page-title">Employee Leaves</div>

  <div class="controls">
    <button class="btn primary pill" (click)="loadLeaves()">Refresh Leaves</button>
    <button class="btn pill" (click)="showLeaveTypeManager = !showLeaveTypeManager">Manage Leave Types</button>
  </div>
  

  <h4>Create Leave</h4>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <select class="input" [(ngModel)]="newLeave.employeeId">
      <option [ngValue]="null">Select employee</option>
      <option *ngFor="let e of employees" [ngValue]="e.id">{{ e.firstName }} {{ e.lastName }}</option>
    </select>
    <select class="input" [(ngModel)]="newLeave.leaveTypeId">
      <option [ngValue]="null">Select leave type</option>
      <option *ngFor="let t of leaveTypes" [ngValue]="t.id">{{ t.name }}</option>
    </select>
    <input class="input" type="date" [(ngModel)]="newLeave.startDate" />
    <input class="input" type="date" [(ngModel)]="newLeave.endDate" />
    <input class="input" placeholder="Notes" [(ngModel)]="newLeave.notes" />
    <button class="btn primary pill" (click)="createLeave()" [disabled]="!newLeave.employeeId || !newLeave.leaveTypeId || !newLeave.startDate">Create</button>
  </div>

  <div style="margin-top:0.75rem">
    <table class="shifts-table">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Type</th>
          <th>Start</th>
          <th>End</th>
          <th>Notes</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let l of leaves">
          <ng-container *ngIf="editingLeaveId !== l.id; else editRow">
            <td>{{ l.employee?.firstName }} {{ l.employee?.lastName }}</td>
            <td>{{ l.leaveType?.name }}</td>
            <td>{{ l.startDate | date }}</td>
            <td>{{ l.endDate | date }}</td>
            <td>{{ l.notes }}</td>
            <td>
              <button class="btn pill" (click)="startEditLeave(l)">Edit</button>
              <button class="btn pill danger" (click)="deleteLeave(l)">Delete</button>
            </td>
          </ng-container>
          <ng-template #editRow>
            <td>
              <select class="input" [(ngModel)]="editLeaveModel.employeeId">
                <option [ngValue]="null">Select employee</option>
                <option *ngFor="let e of employees" [ngValue]="e.id">{{ e.firstName }} {{ e.lastName }}</option>
              </select>
            </td>
            <td>
              <select class="input" [(ngModel)]="editLeaveModel.leaveTypeId">
                <option [ngValue]="null">Select type</option>
                <option *ngFor="let t of leaveTypes" [ngValue]="t.id">{{ t.name }}</option>
              </select>
            </td>
            <td><input class="input" type="date" [(ngModel)]="editLeaveModel.startDate" /></td>
            <td><input class="input" type="date" [(ngModel)]="editLeaveModel.endDate" /></td>
            <td><input class="input" [(ngModel)]="editLeaveModel.notes" /></td>
            <td>
              <button class="btn" (click)="saveEditLeave()" [disabled]="!canSaveLeave()">Save</button>
              <button class="btn" (click)="cancelEditLeave()">Cancel</button>
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="showLeaveTypeManager" class="card" style="margin-top:1rem">
    <h4>Leave Types</h4>
    <div style="display:flex;gap:0.5rem;align-items:center">
      <input class="input" placeholder="Name" [(ngModel)]="newLeaveType.name" />
      <input class="input" placeholder="Description" [(ngModel)]="newLeaveType.description" />
      <button class="btn primary pill" (click)="createLeaveType()">Create</button>
      <button class="btn pill" (click)="newLeaveType = { name: '', description: '' }">Cancel</button>
      <button class="btn pill" (click)="showLeaveTypeManager = false">Close</button>
    </div>

    <div style="margin-top:0.5rem">
      <table class="shifts-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of leaveTypes">
            <ng-container *ngIf="editingLeaveTypeId !== t.id; else editTypeRow">
              <td>{{ t.name }}</td>
              <td>{{ t.description }}</td>
              <td>
                <button class="btn pill" (click)="startEditLeaveType(t)">Edit</button>
                <button class="btn pill danger" (click)="deleteLeaveType(t)">Delete</button>
              </td>
            </ng-container>
            <ng-template #editTypeRow>
              <td>
                <input class="input" [(ngModel)]="editLeaveTypeModel.name" />
              </td>
              <td>
                <input class="input" [(ngModel)]="editLeaveTypeModel.description" />
              </td>
              <td>
                <button class="btn primary pill" (click)="saveEditLeaveType()" [disabled]="!editLeaveTypeModel?.name">Save</button>
                <button class="btn pill" (click)="cancelEditLeaveType()">Cancel</button>
              </td>
            </ng-template>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>
