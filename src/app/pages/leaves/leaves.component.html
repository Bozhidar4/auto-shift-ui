<div class="card">
  <div class="page-header">
    <div class="page-title"><mat-icon class="page-title-icon" aria-hidden="true">person_off</mat-icon>Employee Leaves</div>
    <div class="controls">
      <button class="btn primary pill" (click)="loadLeaves()">Refresh Leaves</button>
      <button class="btn pill" (click)="showLeaveTypeManager = !showLeaveTypeManager">Manage Leave Types</button>
    </div>
  </div>

  <div class="create-leave-container">
    <select class="input" [(ngModel)]="newLeave.employeeId" (ngModelChange)="onEmployeeSelect($event)">
      <option [ngValue]="null">Select employee</option>
      @for (e of employees; track $index) {
      <option [ngValue]="e.id">{{ e.firstName }} {{ e.lastName }}</option>
      }
    </select>
    <select class="input" [(ngModel)]="newLeave.leaveTypeId">
      <option [ngValue]="null">Select leave type</option>
      @for (leaveType of leaveTypes; track $index) {
      <option [ngValue]="leaveType.id">{{ leaveType.name }}</option>
      }
    </select>
    <input class="input" type="date" [(ngModel)]="newLeave.startDate" />
    <input class="input" type="date" [(ngModel)]="newLeave.endDate" />
    <input class="input" placeholder="Notes" [(ngModel)]="newLeave.notes" />
    <button class="btn primary pill" (click)="createLeave()"
      [disabled]="!newLeave.employeeId || !newLeave.leaveTypeId || !newLeave.startDate">Create</button>
  </div>

  <div class="table-container">
    <table class="leave-table mat-elevation-z3">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Type</th>
          <th>Start</th>
          <th>End</th>
          <th>Notes</th>
          <th></th>
        </tr>
      </thead>
      @if (leaves && leaves.length > 0) {
      <tbody>
        @for (l of leaves; track $index) {
        <tr>
          <ng-container *ngIf="editingLeaveId !== l.id; else editRow">
            <td>{{ l.employee?.firstName }} {{ l.employee?.lastName }}</td>
            <td>{{ l.leaveType?.name }}</td>
            <td>{{ l.startDate | date }}</td>
            <td>{{ l.endDate | date }}</td>
            <td>{{ l.notes }}</td>
            <td class="leave-action-container">
              <button class="btn pill" (click)="startEditLeave(l)">Edit</button>
              <button class="btn pill danger" (click)="deleteLeave(l)">Delete</button>
            </td>
          </ng-container>
          <ng-template #editRow>
            <td>
              <select class="input" [(ngModel)]="editLeaveModel.employeeId">
                <option [ngValue]="null">Select employee</option>
                @for (e of employees; track $index) {
                <option [ngValue]="e.id">{{ e.firstName }} {{ e.lastName }}</option>
                }
              </select>
            </td>
            <td>
              <select class="input" [(ngModel)]="editLeaveModel.leaveTypeId">
                <option [ngValue]="null">Select type</option>
                <option *ngFor="let t of leaveTypes" [ngValue]="t.id">{{ t.name }}</option>
              </select>
            </td>
            <td><input class="input" type="date" [(ngModel)]="editLeaveModel.startDate" /></td>
            <td><input class="input" type="date" [(ngModel)]="editLeaveModel.endDate" /></td>
            <td><input class="input" [(ngModel)]="editLeaveModel.notes" /></td>
            <td class="leave-action-container">
              <button class="btn primary pill" (click)="saveEditLeave()" [disabled]="!canSaveLeave()">Save</button>
              <button class="btn pill" (click)="cancelEditLeave()">Cancel</button>
            </td>
          </ng-template>
        </tr>
        }
      </tbody>
      }
      @else {
      @if (!selectedEmployeeId) {
      <div class="muted no-leave-found">Please select an employee to view their leaves.</div>
      }
      @else {
      <div class="muted no-leave-found">No leaves found for the selected employee.</div>
      }
      }
    </table>
  </div>

  @if (showLeaveTypeManager) {
  <div class="card leave-type-container">
    <div class="leave-type-title-container">
      <div class="page-title"><mat-icon class="page-title-icon" aria-hidden="true">personal_injury</mat-icon>Leave Types</div>
      <button class="btn pill" aria-label="Close"
        (click)="showLeaveTypeManager = false; newLeaveType = createEmptyLeaveType()">âœ•</button>
    </div>
    <div class="leave-type-input-container">
      <input class="input" placeholder="Name" [(ngModel)]="newLeaveType.name" />
      <input class="input" placeholder="Description" [(ngModel)]="newLeaveType.description" />
      <button class="btn primary pill" (click)="createLeaveType()">Create</button>
      <button class="btn pill" (click)="newLeaveType = createEmptyLeaveType()">Cancel</button>
    </div>

    <div style="margin-top:0.5rem">
      <table class="leave-type-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          @for (t of leaveTypes; track $index) {
          <tr>
            <ng-container *ngIf="editingLeaveTypeId !== t.id; else editTypeRow">
              <td>{{ t.name }}</td>
              <td>{{ t.description }}</td>
              <td class="leave-type-action-container">
                <button class="btn pill" (click)="startEditLeaveType(t)">Edit</button>
                <button class="btn pill danger" (click)="deleteLeaveType(t)">Delete</button>
              </td>
            </ng-container>
            <ng-template #editTypeRow>
              <td>
                <input class="input" [(ngModel)]="editLeaveTypeModel.name" />
              </td>
              <td>
                <input class="input" [(ngModel)]="editLeaveTypeModel.description" />
              </td>
              <td class="leave-type-action-container">
                <button class="btn primary pill" (click)="saveEditLeaveType()"
                  [disabled]="!editLeaveTypeModel.name">Save</button>
                <button class="btn pill" (click)="cancelEditLeaveType()">Cancel</button>
              </td>
            </ng-template>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }
  <app-confirm [visible]="confirmState.visible" [title]="confirmState.title" [message]="confirmState.message"
    [confirmLabel]="confirmState.confirmLabel || null" [cancelLabel]="confirmState.cancelLabel || null"
    (confirmed)="onConfirmedDelete()" (cancelled)="onCancelledDelete()"></app-confirm>
</div>