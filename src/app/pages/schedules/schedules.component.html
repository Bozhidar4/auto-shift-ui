<div class="card">
	<div style="display:flex;justify-content:space-between;align-items:center">
		<div>
			<div class="page-title">Schedules</div>
			<div class="muted">Generate and review team schedules</div>
		</div>
		<div class="controls">
						<select class="input" [(ngModel)]="selectedTeamId" (change)="onTeamChange()">
				<option [ngValue]="null">Select team</option>
				<option *ngFor="let t of teams" [ngValue]="t.id">{{ t.name }}</option>
			</select>
			<input class="input" type="date" [(ngModel)]="startDate" />
			<input class="input" type="date" [(ngModel)]="endDate" />
						<button class="btn primary pill" (click)="generate()" [disabled]="!selectedTeamId || !startDate || !endDate">Generate</button>
						<button class="btn pill" (click)="download()">Download</button>
		</div>
	</div>

	<div style="margin-top:1rem">
		<div class="muted" style="margin-bottom:0.5rem">Existing schedules for selected team</div>
		<div *ngIf="!selectedTeamId" class="muted" style="padding:1rem">Select a team to see existing schedules.</div>
		<div *ngIf="selectedTeamId && schedules && schedules.length === 0" class="muted" style="padding:1rem">No schedules found for this team.</div>
		<div *ngIf="schedules && schedules.length > 0" style="display:flex;flex-direction:column;gap:0.5rem">
			<div *ngFor="let sch of schedules" class="card" style="display:flex;justify-content:space-between;align-items:center">
				<div>
					<div style="font-weight:700">Schedule: {{ sch.id }}</div>
					<div class="muted">Start: {{ sch.startDate | date:'yyyy-MM-dd' }} — End: {{ sch.endDate | date:'yyyy-MM-dd' }}</div>
				</div>
				<div style="margin-left:auto;display:flex;gap:0.5rem;align-items:center">
					<button class="btn pill" (click)="viewSchedule(sch)">View</button>
					<button class="btn pill danger" (click)="deleteScheduleConfirm(sch)">Delete</button>
				</div>

				<!-- Reusable confirm modal -->
				<app-confirm [visible]="confirmState.visible" [title]="confirmState.title" [message]="confirmState.message" (confirmed)="onConfirmedDelete()" (cancelled)="onCancelledDelete()"></app-confirm>

			</div>
		</div>

		<!-- Modal: view schedule -->
		<div *ngIf="viewingSchedule" class="modal-overlay">
			<div class="modal-card card">
				<div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
					<div style="font-weight:700">Schedule {{ viewingSchedule.id }} — {{ viewingSchedule.startDate | date:'dd MMM yyyy' }} → {{ viewingSchedule.endDate | date:'dd MMM yyyy' }}</div>
					<button class="btn pill" aria-label="Close" (click)="closeView()">✕</button>
				</div>
				<div class="modal-body" style="overflow:auto;height:85vh">
					<div class="table-wrapper">
						<table class="view-table" style="width:100%;border-collapse:collapse;table-layout:auto">
							<thead>
								<tr>
									<th class="sticky-col" style="border:1px solid #eee;padding:6px;background:#fff">Employee</th>
									<th *ngFor="let d of tableDates" style="border:1px solid #eee;padding:6px;background:#fff;white-space:nowrap">{{ formatDateHeader(d) }}</th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let emp of tableEmployees">
									<td class="sticky-col emp-cell">{{ emp.name }}</td>
									<td *ngFor="let d of tableDates" class="data-cell">
										<ng-container [ngSwitch]="!!tableCells[emp.id + '__' + d]">
											<div *ngSwitchCase="true" class="cell-content">
												<select class="input full-width" [(ngModel)]="tableCells[emp.id + '__' + d].shiftTypeId" [disabled]="isPastDate(d)">
													<option [ngValue]="null">-</option>
													<option *ngFor="let st of shiftTypes" [ngValue]="st.id">{{ st.initialCode }}</option>
												</select>
												<div class="cell-actions">
													<button class="btn primary pill" (click)="saveCell(emp.id, d)" [disabled]="isPastDate(d)">Save</button>
												</div>
											</div>
											<div *ngSwitchDefault class="cell-content">
												<!-- editable empty cell -->
												<select class="input full-width" [(ngModel)]="emptyCellModel[emp.id + '__' + d]" [disabled]="isPastDate(d)">
													<option [ngValue]="null">-</option>
													<option *ngFor="let st of shiftTypes" [ngValue]="st.id">{{ st.initialCode }}</option>
												</select>
												<div class="cell-actions">
													<button class="btn primary pill" (click)="createEmptyCellAndSave(emp.id, d)" [disabled]="isPastDate(d)">Save</button>
												</div>
											</div>
										</ng-container>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
